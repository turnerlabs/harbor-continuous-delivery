machine:
  pre:

  # install newer docker
  - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0

  # install newer docker-compose
  - sudo pip install docker-compose

  services:
    - docker

dependencies:  
  override:

  # use harbor-deploy to get image tag (version) from package.json (or TURNER_METADATA)
  - docker login -e="." -u="${DOCKER_USER}" -p="${DOCKER_PASS}" quay.io
  - docker run -v `pwd`:/data quay.io/turner/harbor-deploy:0.3.0 set_build_values -d /data -b $CIRCLE_BRANCH -n $CIRCLE_BUILD_NUM > props && cp props .env
  
  # add additional props
  - printf "SHIPMENT=harbor-continuous-delivery\n" >> props
  - printf "ENVIRONMENT=dev\n" >> props
  - printf "TOKEN=${BUILD_TOKEN}\n" >> props

test:
  override:

  # build image using version number generated by script above
  - docker-compose build

  # spin up stack and test
  - docker-compose up -d && sleep 10
  - docker-compose logs
  - npm test

  # push to docker registry
  - docker-compose push

  # catalog in harbor
  - docker run --env-file props quay.io/turner/harbor-deploy:0.3.0 catalog
